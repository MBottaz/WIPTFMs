import requests
import json
import pandas as pd

from library.Consumption import plot_gaussian_curve, load_csv, reprocess_csv_edistribuzione

def calculate_pv_module_output(latitude, longitude, efficiency, azimuth, slope, module_power=0.5, system_losses=15, save_output="N"):

    # Parameters:
    # latitude (float): Latitude of the location (degrees)
    # longitude (float): Longitude of the location (degrees)
    # efficiency (float): Efficiency of the PV system after losses (percentage between 0 and 1)
    # azimuth (float): Azimuth angle of the panels in degrees (0° = south, 90° = west, 180° = north, 270° = east)
    # slope (float): Tilt angle of the panels in degrees (0° = horizontal, 90° = vertical)
    # module_power (float): Rated power of the PV module in kW (default is 0.5 kW)
    # system_losses (float): Total system losses as a percentage (default is 15%)
    # save_output (str): Option to save output as JSON ("Y" for yes, "N" for no, default is "N")

    # The output DataFrame contains the following columns:
    # 1. time: Timestamp of the data point (format: YYYYMMDD:HHMM)
    # 2. P: AC power output (kW) - The total electrical power generated by the PV system.
    # 3. G(i): In-plane irradiance (W/m²) - Solar radiation incident on the surface of the panel.
    # 4. H_sun: Sun height angle (°) - The angle of the sun relative to the horizon.
    # 5. T2m: Air temperature (°C) - Temperature of the air 2 meters above the ground.
    # 6. WS10m: Wind speed at 10 meters (m/s) - Wind speed measured 10 meters above the ground.
    # 7. Int: Irradiance intensity (W/m²) - Intensity of sunlight reaching the surface (could include direct and diffuse irradiance).

    
    # PVGIS API endpoint
    url = "https://re.jrc.ec.europa.eu/api/seriescalc"

    # Define API call parameters
    params = {
        "lat": latitude,  # Latitude of the location
        "lon": longitude,  # Longitude of the location
        "outputformat": "json",  # Output format: JSON
        "pvcalculation": "1",  # PV system calculation mode
        "peakpower": module_power,  # Rated power of the PV module/system in kW
        "angle": int(slope),  # Tilt angle of the PV panels in degrees
        "aspect": int(azimuth),  # Azimuth angle of the PV panels in degrees
        "efficiency": efficiency,  # Efficiency of the system after losses
        "raddatabase": "PVGIS-ERA5",  # Solar radiation database used
        "startyear": "2023",  # Start year for the data (valid range 2005-2023)
        "endyear": "2023",  # End year for the data (valid range 2005-2023)
        "timeseries": "1",  # Request for hourly output data
        "mountingplace": "free",  # Mounting place type: "free" for free-standing panels
        "loss": system_losses  # Total system losses (e.g., 15% losses)
    }

    # Send the API request to the PVGIS service
    response = requests.get(url, params=params)

    # Check if the request was successful (HTTP status code 200)
    if response.status_code == 200:
        try:
            # Parse the JSON response from the PVGIS API
            data = response.json()

            # Extract hourly timeseries data and convert to DataFrame
            timeseries = data["outputs"]["hourly"]
            df = pd.DataFrame(timeseries)
            # Convert time from string to datetime format for easier manipulation
            df["datetime"] = pd.to_datetime(df["time"], format="%Y%m%d:%H%M")

            # Optionally save the JSON response to a local file
            if save_output.upper() == "Y":
                with open("energy_production.json", "w", encoding="utf-8") as f:
                    json.dump(data, f, ensure_ascii=False, indent=4)
                print("JSON file with energy production has been saved as 'energy_production.json'.")
            
            # print("Data processing complete!")
            return df
        except ValueError:
            # Handle potential errors when parsing the JSON data
            print("Error decoding the response data.")
            return None
    else:
        # If the API request fails, handle the error and print details
        try:
            # Attempt to parse JSON error response for more information
            error_info = response.json()
            print(f"Error details: {error_info}")
        except ValueError:
            # If the error response is not JSON, print the raw response text
            print(f"Error: {response.text}")
        
        return None
    
def add_pv_est(df, pv_df):
    """
    Add PV production data to consumption dataframe.
    
    Parameters:
        df (pandas.DataFrame): Dataframe with consumption data in long format.
        pv_df (pandas.DataFrame): Dataframe with PV production data.
        
    Returns:
        pandas.DataFrame: Merged dataframe with consumption and PV production.
    """ 
    # Merge consumption and PV data on timestamp
    merged_df = pd.merge(df, pv_df[['datetime', 'P']], left_on='timestamp', right_on='datetime', how='left')
    
    # Rename PV production column
    merged_df.rename(columns={'P': 'pv_production'}, inplace=True)
    
    # Drop redundant datetime column
    merged_df.drop(columns=['datetime'], inplace=True)
    
    return merged_df

if __name__ == "__main__":

    # Example usage
    latitude = 44.516  # Provided latitude
    longitude = 11.518  # Provided longitude
    efficiency = 0.23  # 23% efficiency
    azimuth = 23
    slope = 35
    module_power = 0.47  # 470W module

    df = calculate_pv_module_output(latitude, longitude, efficiency, azimuth, slope, module_power)
    df_daily = df.set_index('datetime').resample('D').sum()
    print(df_daily.head())
    statistics = plot_gaussian_curve(df_daily['P'], label="PV Output (kW)")



